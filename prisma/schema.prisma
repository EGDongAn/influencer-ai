// Prisma schema for Influencer Marketing Management System
// Hospital influencer collaboration platform

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
  schemas   = ["influencer"]
}

// 모든 모델은 influencer 스키마에 생성됨

// ============================================
// 인플루언서 (Influencer)
// ============================================
model Influencer {
  id              String   @id @default(cuid())
  name            String
  nickname        String?  // 활동명
  email           String?
  phone           String?
  profileImageUrl String?

  // 티어 및 카테고리
  tier            InfluencerTier @default(SILVER)
  category        String[]       // 뷰티, 건강, 라이프스타일 등

  // 채널 정보
  channels        Channel[]

  // 메모 및 특이사항
  notes           String?

  // 협업 이력
  collaborations  Collaboration[]

  // 상태
  isActive        Boolean  @default(true)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([tier])
  @@index([isActive])
  @@index([createdAt])
  @@map("influencers")
  @@schema("influencer")
}

enum InfluencerTier {
  VIP
  GOLD
  SILVER
  BRONZE

  @@schema("influencer")
}

// ============================================
// 채널 (Channel) - 인플루언서의 SNS 채널
// ============================================
model Channel {
  id            String      @id @default(cuid())
  influencerId  String
  influencer    Influencer  @relation(fields: [influencerId], references: [id], onDelete: Cascade)

  platform      Platform
  handle        String      // @username 또는 채널명
  url           String?
  followerCount Int?

  // 콘텐츠 링크
  contents      Content[]

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([influencerId])
  @@index([platform])
  @@map("channels")
  @@schema("influencer")
}

enum Platform {
  YOUTUBE
  INSTAGRAM
  TIKTOK
  BLOG_NAVER
  BLOG_OTHER
  FACEBOOK
  TWITTER
  OTHER

  @@schema("influencer")
}

// ============================================
// 캠페인 (Campaign)
// ============================================
model Campaign {
  id              String          @id @default(cuid())
  name            String
  description     String?

  // 병원/클라이언트 정보
  clientName      String          // 병원명
  clientContact   String?         // 담당자 연락처

  // 캠페인 기간
  startDate       DateTime
  endDate         DateTime?

  // 캠페인 유형
  type            CampaignType    @default(COLLABORATION)

  // 예산
  budget          Decimal?        @db.Decimal(12, 0)

  // 상태
  status          CampaignStatus  @default(PLANNING)

  // 협업 목록
  collaborations  Collaboration[]

  // 메모
  notes           String?

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([status])
  @@index([type])
  @@index([startDate])
  @@index([clientName])
  @@map("campaigns")
  @@schema("influencer")
}

enum CampaignType {
  COLLABORATION   // 협찬
  ADVERTISEMENT   // 광고
  EVENT           // 이벤트
  REVIEW          // 리뷰
  OTHER

  @@schema("influencer")
}

enum CampaignStatus {
  PLANNING        // 기획 중
  IN_PROGRESS     // 진행 중
  COMPLETED       // 완료
  CANCELLED       // 취소됨

  @@schema("influencer")
}

// ============================================
// 협업 (Collaboration) - 캠페인과 인플루언서 연결
// ============================================
model Collaboration {
  id              String              @id @default(cuid())

  campaignId      String
  campaign        Campaign            @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  influencerId    String
  influencer      Influencer          @relation(fields: [influencerId], references: [id], onDelete: Cascade)

  // 협업 조건
  fee             Decimal?            @db.Decimal(12, 0)  // 협찬비
  feeType         FeeType             @default(FIXED)

  // 회차 설정
  shootingRounds  Int                 @default(1)  // 촬영 회차 수
  progressRounds  Int                 @default(2)  // 경과 사진 회차 수

  // 일정 (다중 스케줄 지원)
  schedules       Schedule[]

  // 진행 상태 (칸반 보드용)
  status          CollaborationStatus @default(CONTACTED)

  // 콘텐츠
  contents        Content[]

  // 시술 정보
  treatments      CollaborationTreatment[]

  // 메모
  notes           String?

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@unique([campaignId, influencerId])
  @@index([campaignId])
  @@index([influencerId])
  @@index([status])
  @@map("collaborations")
  @@schema("influencer")
}

enum FeeType {
  FIXED           // 고정 금액
  PER_CONTENT     // 콘텐츠당
  REVENUE_SHARE   // 수익 분배
  BARTER          // 물물교환(시술 제공)

  @@schema("influencer")
}

enum CollaborationStatus {
  CONTACTED       // 컨택 완료
  NEGOTIATING     // 협의 중
  CONFIRMED       // 확정
  SHOOTING_DONE   // 촬영 완료
  PROGRESS_DONE   // 경과사진 완료
  UPLOADED        // 업로드 완료
  COMPLETED       // 협업 완료
  CANCELLED       // 취소됨

  @@schema("influencer")
}

// ============================================
// 스케줄 (Schedule) - 협업 일정 관리
// ============================================
model Schedule {
  id              String         @id @default(cuid())

  collaborationId String
  collaboration   Collaboration  @relation(fields: [collaborationId], references: [id], onDelete: Cascade)

  // 일정 유형
  type            ScheduleType
  title           String?        // 일정 제목 (선택)

  // 회차 관리
  roundNumber     Int?           // 현재 회차 (1, 2, 3...)
  totalRounds     Int?           // 전체 회차 수

  // 일정 시간
  scheduledDate   DateTime       // 예정일
  scheduledTime   String?        // 예정 시간 (HH:mm 형식)
  originalDate    DateTime?      // 원래 예정일 (일정 변경 추적용)

  // 상태
  status          ScheduleStatus @default(SCHEDULED)
  completedAt     DateTime?      // 완료일

  // 메모
  notes           String?

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([collaborationId])
  @@index([type])
  @@index([scheduledDate])
  @@index([status])
  @@map("schedules")
  @@schema("influencer")
}

enum ScheduleType {
  SHOOTING        // 촬영
  PROGRESS        // 경과 사진
  UPLOAD          // 업로드
  MEETING         // 미팅
  REVIEW          // 검토
  OTHER           // 기타

  @@schema("influencer")
}

enum ScheduleStatus {
  SCHEDULED       // 예정됨
  CONFIRMED       // 확정됨
  IN_PROGRESS     // 진행 중
  COMPLETED       // 완료
  CANCELLED       // 취소
  RESCHEDULED     // 일정 변경

  @@schema("influencer")
}

// ============================================
// 콘텐츠 (Content) - 업로드된 콘텐츠
// ============================================
model Content {
  id              String        @id @default(cuid())

  collaborationId String
  collaboration   Collaboration @relation(fields: [collaborationId], references: [id], onDelete: Cascade)

  channelId       String
  channel         Channel       @relation(fields: [channelId], references: [id], onDelete: Cascade)

  // 콘텐츠 정보
  title           String?
  url             String
  contentType     ContentType   @default(VIDEO)

  // 업로드 정보
  uploadedAt      DateTime?

  // 성과 지표
  views           Int           @default(0)
  likes           Int           @default(0)
  comments        Int           @default(0)
  shares          Int           @default(0)

  // 성과 업데이트 시간
  metricsUpdatedAt DateTime?

  // 메모
  notes           String?

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([collaborationId])
  @@index([channelId])
  @@index([contentType])
  @@index([uploadedAt])
  @@map("contents")
  @@schema("influencer")
}

enum ContentType {
  VIDEO           // 영상
  SHORTS          // 숏폼 (릴스, 쇼츠, 틱톡)
  IMAGE           // 이미지 포스트
  BLOG            // 블로그 글
  STORY           // 스토리
  OTHER

  @@schema("influencer")
}

// ============================================
// 시술 카테고리 (TreatmentCategory) - 계층 구조
// ============================================
model TreatmentCategory {
  id              String   @id @default(cuid())
  name            String   // 카테고리명 (영문)
  nameKo          String?  // 한국어명
  slug            String   @unique // URL-safe identifier

  // 계층 구조
  parentId        String?
  parent          TreatmentCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children        TreatmentCategory[] @relation("CategoryHierarchy")

  // 시술 목록
  treatments      Treatment[]

  // manual.n1b.kr 연동
  manualCategoryId String? // 매뉴얼 시스템 카테고리 ID

  // 표시 설정
  displayOrder    Int      @default(0)  // 정렬 순서
  isFeatured      Boolean  @default(false) // 대표 시술 5개 표시용

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([parentId])
  @@index([displayOrder])
  @@map("treatment_categories")
  @@schema("influencer")
}

// ============================================
// 시술 (Treatment) - manual.n1b.kr 연동
// ============================================
model Treatment {
  id              String   @id @default(cuid())
  name            String   // 시술명
  nameKo          String?  // 한국어명

  // 카테고리 (계층 구조)
  categoryId      String?
  treatmentCategory TreatmentCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  category        String?  // 레거시 필드 (마이그레이션 후 제거 예정)

  // manual-ai 연동 정보
  manualId        String?  @unique // manual.n1b.kr의 시술 ID

  // 시술 상세 정보
  description     String?  // 시술 설명
  duration        Int?     // 소요시간 (분)
  priceMin        Decimal? @db.Decimal(12, 0) // 최소 가격
  priceMax        Decimal? @db.Decimal(12, 0) // 최대 가격
  recoveryDays    Int?     // 회복 기간 (일)

  // 촬영/경과 회차 기본값
  defaultShootingRounds Int @default(1)
  defaultProgressRounds Int @default(2)

  // 대표 시술 표시
  isFeatured      Boolean  @default(false)

  // 관련 협업
  collaborations  CollaborationTreatment[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  syncedAt        DateTime? // manual-ai 마지막 동기화 시간

  @@index([categoryId])
  @@index([category])
  @@index([manualId])
  @@index([isFeatured])
  @@map("treatments")
  @@schema("influencer")
}

// Collaboration과 Treatment 연결 (다대다)
model CollaborationTreatment {
  id              String        @id @default(cuid())
  collaborationId String
  collaboration   Collaboration @relation(fields: [collaborationId], references: [id], onDelete: Cascade)
  treatmentId     String
  treatment       Treatment     @relation(fields: [treatmentId], references: [id], onDelete: Cascade)

  // 시술 관련 메모
  notes           String?

  createdAt       DateTime @default(now())

  @@unique([collaborationId, treatmentId])
  @@index([collaborationId])
  @@index([treatmentId])
  @@map("collaboration_treatments")
  @@schema("influencer")
}

// ============================================
// AI 대화 기록 (AIConversation)
// ============================================
model AIConversation {
  id            String      @id @default(cuid())
  sessionId     String      // 세션 ID
  title         String?     // 대화 제목
  messages      AIMessage[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([sessionId])
  @@map("ai_conversations")
  @@schema("influencer")
}

model AIMessage {
  id              String         @id @default(cuid())
  conversationId  String
  conversation    AIConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  role            MessageRole    // user, assistant, system
  content         String

  // 함수 호출 정보 (데이터 업데이트 시)
  toolCalls       Json?
  toolResults     Json?

  createdAt       DateTime @default(now())

  @@index([conversationId])
  @@map("ai_messages")
  @@schema("influencer")
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
  TOOL

  @@schema("influencer")
}
